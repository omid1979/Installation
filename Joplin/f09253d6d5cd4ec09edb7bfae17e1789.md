ELK

Installing ELK Log management



در این مستند به نحوه نصب و راه اندازی elk stack میپردازیم . elk stack مجتمع از سه محصول open source است که عبارتند از : elastic search  , logtash , kibana

Elastic Stack



elastic stack  یک موتور جستجو و تحلیل کاملا متنی است که بر اساس موتور جستجوی apache lucene طراحی و ساخته شده است .

logstach یک مجتمع کننده لاگ است که از ورودی های مختلف داده میگیرد و بعد از انجام یک سری تغییرات و بهبودها ، داده ها را به خروجی های مختلفی میفرستد.

kibana یک لایه ویژوال است که بالای elastic search قرار میگیرد و به کاربر امکان تصویری کردن داده ها و آنالیز کردن آنها را میدهد.
نصب و کانفیگ Elastic Search: 

برای نصب باید تمامی این دستورات بر روی سروری اجرا شود که به اینترنت دسترسی دارد.

مرحله اول: تنظیم ریپوزیتوری yum  برای نصب پکیج های مورد نیاز elk stackاست :
## ------------------------
## Configure yum repository
## ------------------------
## Download and install the public signing key
sudo rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch
  
## Create the repository file
sudo vi /etc/yum.repos.d/elasticsearch.repo
---------------------
[elasticsearch]
name=Elasticsearch repository for 7.x packages
baseurl=https://artifacts.elastic.co/packages/7.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=1
autorefresh=1
type=rpm-md
---------------------
:wq


مرحله دوم: نصب elastic search و اجرا کردن سرویس آن است
## ---------------------
## Install elasticsearch
## ---------------------
## Install elasticsearch
sudo yum install elasticsearch
 
## Enable and start elasticsearch
sudo systemctl enable elasticsearch
sudo systemctl start elasticsearch
sudo systemctl status elasticsearch
 
## Check if elasticsearch installed successfully
curl -X GET "localhost:9200/?pretty"


مرحله سوم: کانفیگ elastic search 
## View elasticsearch configuration
sudo cat /etc/elasticsearch/elasticsearch.yml
 
##need to change these directories
path.data: /opt/elasticsearch/data
path.logs: /opt/elasticsearch/log
 
##need to change ip and port
network.host: 172.29.140.3(IP-OF-SERVER)
http.port: 9200
 
 
##define single-node
discovery.type: single-node



نصب و کانفیگ Kibana:


## --------------
## Install kibana
## --------------
## Install kibana
sudo yum install kibana
  
## Enable and start kibana
sudo systemctl enable kibana
sudo systemctl start kibana
sudo systemctl status kibana
  
 
## Stop firewall
## or open kibana default port using firewall-cmd --add-port=5601/tcp --permanent
sudo systemctl stop firewalld
  
## Restart kibana
sudo systemctl restart kibana

برای کانفیگ هم کافی است مقدار آی پی سرور را وارد کنیم:
## View and eidt kibana configuration to connect remotely
sudo vi /etc/kibana/kibana.yml
---------------------
server.host: "IP-OF-SERVER"
---------------------
:wq


برای تست صحت بالا آمدن kibana ، میتوانید آدرس و پورت آن را در browser وارد کنید :    http://IP-OF-Server:5601

کار دیگری که بهتر است انجام دهیم نصب پلاگین logtrail  در کیباناست .برای این کار کافی است که مراحل زیر را انجام دهیم:
## get the same version of kibana
wget  https://github.com/sivasamyk/logtrail/releases/download/v0.1.31/logtrail-7.9.2-0.1.31.zip
 
##install logtrail
##cd kibana bin
./kibana-plugin --allow-root install file:///root/logtrail-7.9.2-0.1.31.zip


نصب و کانفیگ Logstash:


## ----------------
## Install Logstash
## ----------------
## Install logstash
sudo yum install logstash
  
## Enable and start logstash
sudo systemctl start logstash
sudo systemctl enable logstash
sudo systemctl status logstash


فایل های کانفیگ logstash نیز در این مسیر قرار دارد:   /etc/logstash

کاری که ما قرار است در اینجا انجام دهیم ، فرستادن لاگ های سرورها  از طریق filebeat به logstash است .برای این کار باید چند کا رانجام داد. در مرحله اول کانفیگ کردن logtash :
## ----------------
## cd /etc/logstash/conf.d/
vim filebeat.conf
input {
  beats {
    port => 5044
  }
}
 
# The filter part of this file is commented out to indicate that it
# is optional.
# filter {
#
# }
 
output {
  elasticsearch {
    hosts => "localhost:9200"
    manage_template => false
    index => "%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}"
  }
}

کار دیگری که باید انجام داد نصب کردن پلاگینهای input , output که در فایل تعریف کردیم است. (برای این کار نیاز است که سرور اینترنت داشته باشد)
##cd /usr/share/logstash/bin
./logstash-plugin install logstash-input-beats
./logstash-plugin install logstash-output-elasticsearch


فعال کردن x-pack بر روی elkstack :

برای انجام این کار باید دستورات زیر را انجام دهید:
####note: every thing in ELK_HOME and ELK_CONFIG must be owned by elasticsearch
1- Create a certificate authority for your Elasticsearch cluster. path of certificate file must under /etc/elasticsearch
# bin/elasticsearch-certutil ca
 
2- Generate a certificate and private key for each node in your cluster
# bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12
 
3- edit elasticsearch.yml and add bellow line
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: /etc/elasticsearch/certs/elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: /etc/elasticsearch/certs/elastic-certificates.p12
 
4- change ownership to elasticsearch
# chown -R elasticsearch. /usr/share/elasticsearch /etc/easticsearch
5- run these commands
#bin/elasticsearch-keystore add xpack.security.http.ssl.keystore.secure_password
#bin/elasticsearch-keystore add xpack.security.http.ssl.truststore.secure_password
#bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password
#bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password
 
6- restart elasticsearch
# systemctl restart elasticsearch
 
7- create password for default user
# bin/elasticsearch-setup-passwords interactive
 
8- edit kibana to use user/pass to connect elasticsearch . edit bellow line in kibana.yml
elasticsearch.username: "kibana_system"
elasticsearch.password: "123456"
 
9- edit logstash to connect with user/pass to elasticsearch
• edit logstash.yml and edit bellow line:
xpack.monitoring.enabled: true
xpack.monitoring.elasticsearch.username: logstash_system
xpack.monitoring.elasticsearch.password: 123456
xpack.monitoring.elasticsearch.hosts: ["http://IP-OF-Server:9200"]
xpack.management.enabled: true
xpack.management.pipeline.id: ["main", "apache_logs"]
xpack.management.elasticsearch.username: logstash_admin_user
xpack.management.elasticsearch.password: 123456
xpack.management.elasticsearch.hosts: ["http://IP-OF-Server:9200"]
• edit output config
hosts => ["192.168.209.51:9200"]
user => "elastic"
password => "123456"


توجه کنید که در فایل کانفیگ logstash باید مقادیر input , output مشخص شده باشند.


توجه داشته باشید که اگر قرار باشد نسخه خاصی از elk stack را بر روی سیستم خود نصب کنید باید این مراحل را طی کنید:
##find the appropriate version :
yum list elasticsearch --showduplicates
 
##install the version , for exmaple 7.9.2
yum install elasticsearch-7.9.2-1

توجه داشته باشید که باید ورژنهای تمام ابزارهای استک ، یکی باشد .یعنی نسخه elastic search و kibana و logsatsh و حتی پلاگینهایی مثل logtrail که بر روی کیبانا نصب میشود.


نصب و کانفیگ Filebeat :

برای نصب کافی است مراحل زیر را طی کنید:
##add key
sudo rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch
 
##add elastic repository
vim /etc/yum.repos.d/elastic.repo
 
[elastic-7.x]
name=Elastic repository for 7.x packages
baseurl=https://artifacts.elastic.co/packages/7.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=1
autorefresh=1
type=rpm-md
 
##install
yum install filebeat


به منظور کانفیگ کردن فایل بیت کافی است این موارد را کانفیگ کنیم:
##vim /etc/filebeat/filebeat.yml
 
*************
- type: log
 
  # Change to true to enable this input configuration.
  enabled: true
 
  # Paths that should be crawled and fetched. Glob based paths.
  paths:
    - /opt/ibm/wlp/usr/servers/defaultServer/logs/console.log
    - /opt/ibm/wlp/usr/servers/defaultServer01/logs/console.log
*********************
in general part add tags:
 
tags: ["baam-api_107.133"]
 
***************************
add kibana host in "kibana" part:
 
host: "172.29.140.3:5601"
 
***************************
add logstash host in "Logstash Output" part:
 
 hosts: ["172.29.140.3:5044"]
****************************
 
 
 
sudo systemctl enable filebeat
sudo systemctl restart filebeat
نصب و کانفیگ Curator :

به منظور بهینه کردن ایندکس های الک از ابزار مربوطه استفاده میکنیم.برای نصب این پکیج کافی است کارهای زیر را انجام دهیم:
##Download and install the public signing key:
rpm --import https://packages.elastic.co/GPG-KEY-elasticsearch
 
##add curator repo file
vim /etc/yum.repos.d/curator.repo
 
[curator-5]
name=CentOS/RHEL 7 repository for Elasticsearch Curator 5.x packages
baseurl=https://packages.elastic.co/curator/5/centos/7
gpgcheck=1
gpgkey=https://packages.elastic.co/GPG-KEY-elasticsearch
enabled=1
 
 
##install
 yum install elasticsearch-curator





id: f09253d6d5cd4ec09edb7bfae17e1789
parent_id: 9051567a85b34643b4e0252a8fdf0ac0
created_time: 2024-08-26T05:12:11.343Z
updated_time: 2024-08-26T05:28:42.107Z
is_conflict: 0
latitude: 35.68919750
longitude: 51.38897360
altitude: 0.0000
author: 
source_url: 
is_todo: 0
todo_due: 0
todo_completed: 0
source: joplin-desktop
source_application: net.cozic.joplin-desktop
application_data: 
order: 0
user_created_time: 2024-08-26T05:12:11.343Z
user_updated_time: 2024-08-26T05:28:42.107Z
encryption_cipher_text: 
encryption_applied: 0
markup_language: 1
is_shared: 0
share_id: 
conflict_original_id: 
master_key_id: 
user_data: 
deleted_time: 0
type_: 1