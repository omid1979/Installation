Splunk Cluster

# [راه اندازی معماری clustering با استفاده از docker](https://wiki.sadad.co.ir/pages/viewpage.action?pageId=55822319)

![578ed3a497f4a23fb30f9402f87768cf.png](:/83f9e5c020ca423d9b5c1f4098cf4897)

&nbsp;

- ایجاد فایل پیش فرض کامپوز :

`mkdir /opt/splunk-compose`

`cd /opt/splunk-compose`

`docker run -it -e SPLUNK_PASSWORD=<password> splunk/splunk:latest create-defaults >` `default``.yml`

- ایجاد image مورد نیاز برای syslog server :

`1``- create Dockerfile:`

`FROM centos:``7`

`ENV container docker`

`RUN (cd /lib/systemd/system/sysinit.target.wants/;` `for` `i in *;` `do` `[ $i == \`

`systemd-tmpfiles-setup.service ] || rm -f $i; done); \`

`rm -f /lib/systemd/system/multi-user.target.wants/*;\`

`rm -f /etc/systemd/system/*.wants/*;\`

`rm -f /lib/systemd/system/local-fs.target.wants/*; \`

`rm -f /lib/systemd/system/sockets.target.wants/*udev*; \`

`rm -f /lib/systemd/system/sockets.target.wants/*initctl*; \`

`rm -f /lib/systemd/system/basic.target.wants/*;\`

`rm -f /lib/systemd/system/anaconda.target.wants/*;`

`VOLUME [` `"/sys/fs/cgroup"` `]`

`CMD [``"/usr/sbin/init"``]`

`2``- docker build --rm -t local/c7-systemd .`

- ایجاد ایمیج جدید براساس مرحله ی قبل برای syslog server:

`1``- create Dockerfile:`

`FROM local/c7-systemd`

`RUN yum -y install rsyslog; yum clean all; systemctl enable rsyslog`

`RUN yum -y install ipvsadm; yum clean all; systemctl enable ipvsadm`

`RUN yum -y install net-tools; yum clean all;`

`RUN yum -y install tcpdump; yum clean all;`

`CMD [``"/usr/sbin/init"``]`

`2``- docker build --rm -t syslog .`

- ایجاد فایل کامپوز معماری کلاستر اسپلانک:

`1``- create compose file :`

`vim /opt/splunk-compose/splunk-compose.yml`

- اضافه کردن کد زیر به فایل مرحله ی قبل :

`version:` `"3.6"`

`networks:`

`splunknet:`

`driver: bridge`

`attachable:` `true`

`services:`

`so1:`

`networks:`

`splunknet:`

`aliases:`

`- so1`

`image: ${SPLUNK_IMAGE:-splunk/splunk:latest}`

`container_name: so1`

`environment:`

`- SPLUNK_START_ARGS=--accept-license`

`- SPLUNK_LICENSE_URI=/tmp/license/splunk.lic`

`- SPLUNK_PASSWORD`

`- SPLUNK_ROLE=splunk_license_master`

`- SPLUNK_LICENSE_MASTER_URL=so1`

`- SPLUNK_STANDALONE_URL=so1`

`ports:`

`-` `8000`

`-` `8089`

`volumes:`

`- ./splunk.lic:/tmp/license/splunk.lic`

`- ./``default``.yml:/tmp/defaults/``default``.yml`

`sh1:`

`networks:`

`splunknet:`

`aliases:`

`- sh1`

`image: ${SPLUNK_IMAGE:-splunk/splunk:latest}`

`hostname: sh1`

`container_name: sh1`

`environment:`

`- SPLUNK_START_ARGS=--accept-license`

`- SPLUNK_INDEXER_URL=idx1,idx2,idx3`

`- SPLUNK_SEARCH_HEAD_URL=sh2,sh3`

`- SPLUNK_SEARCH_HEAD_CAPTAIN_URL=sh1`

`- SPLUNK_CLUSTER_MASTER_URL=cm1`

`- SPLUNK_ROLE=splunk_search_head_captain`

`- SPLUNK_DEPLOYER_URL=dep1`

`- SPLUNK_LICENSE_MASTER_URL=so1`

`ports:`

`-` `8000`

`-` `8089`

`volumes:`

`- ./``default``.yml:/tmp/defaults/``default``.yml`

`links:`

`- so1:so1`

`sh2:`

`networks:`

`splunknet:`

`aliases:`

`- sh2`

`image: ${SPLUNK_IMAGE:-splunk/splunk:latest}`

`hostname: sh2`

`container_name: sh2`

`environment:`

`- SPLUNK_START_ARGS=--accept-license`

`- SPLUNK_INDEXER_URL=idx1,idx2,idx3`

`- SPLUNK_SEARCH_HEAD_URL=sh2,sh3`

`- SPLUNK_SEARCH_HEAD_CAPTAIN_URL=sh1`

`- SPLUNK_CLUSTER_MASTER_URL=cm1`

`- SPLUNK_ROLE=splunk_search_head`

`- SPLUNK_DEPLOYER_URL=dep1`

`- SPLUNK_LICENSE_MASTER_URL=so1`

`ports:`

`-` `8000`

`-` `8089`

`volumes:`

`- ./``default``.yml:/tmp/defaults/``default``.yml`

`links:`

`- so1:so1`

`sh3:`

`networks:`

`splunknet:`

`aliases:`

`- sh3`

`image: ${SPLUNK_IMAGE:-splunk/splunk:latest}`

`hostname: sh3`

`container_name: sh3`

`environment:`

`- SPLUNK_START_ARGS=--accept-license`

`- SPLUNK_INDEXER_URL=idx1,idx2,idx3`

`- SPLUNK_SEARCH_HEAD_URL=sh2,sh3`

`- SPLUNK_SEARCH_HEAD_CAPTAIN_URL=sh1`

`- SPLUNK_CLUSTER_MASTER_URL=cm1`

`- SPLUNK_ROLE=splunk_search_head`

`- SPLUNK_DEPLOYER_URL=dep1`

`- SPLUNK_LICENSE_MASTER_URL=so1`

`ports:`

`-` `8000`

`-` `8089`

`volumes:`

`- ./``default``.yml:/tmp/defaults/``default``.yml`

`links:`

`- so1:so1`

`dep1:`

`networks:`

`splunknet:`

`aliases:`

`- dep1`

`image: ${SPLUNK_IMAGE:-splunk/splunk:latest}`

`hostname: dep1`

`container_name: dep1`

`environment:`

`- SPLUNK_START_ARGS=--accept-license`

`- SPLUNK_INDEXER_URL=idx1,idx2,idx3`

`- SPLUNK_SEARCH_HEAD_URL=sh2,sh3`

`- SPLUNK_SEARCH_HEAD_CAPTAIN_URL=sh1`

`- SPLUNK_CLUSTER_MASTER_URL=cm1`

`- SPLUNK_ROLE=splunk_deployer`

`- SPLUNK_DEPLOYER_URL=dep1`

`- SPLUNK_LICENSE_MASTER_URL=so1`

`ports:`

`-` `8000`

`-` `8089`

`volumes:`

`- ./``default``.yml:/tmp/defaults/``default``.yml`

`links:`

`- so1:so1`

`cm1:`

`networks:`

`splunknet:`

`aliases:`

`- cm1`

`image: ${SPLUNK_IMAGE:-splunk/splunk:latest}`

`hostname: cm1`

`container_name: cm1`

`environment:`

`- SPLUNK_START_ARGS=--accept-license`

`- SPLUNK_INDEXER_URL=idx1,idx2,idx3`

`- SPLUNK_SEARCH_HEAD_URL=sh2,sh3`

`- SPLUNK_SEARCH_HEAD_CAPTAIN_URL=sh1`

`- SPLUNK_CLUSTER_MASTER_URL=cm1`

`- SPLUNK_ROLE=splunk_cluster_master`

`- SPLUNK_DEPLOYER_URL=dep1`

`- SPLUNK_LICENSE_MASTER_URL=so1`

`ports:`

`-` `8000`

`-` `8089`

`volumes:`

`- ./``default``.yml:/tmp/defaults/``default``.yml`

`links:`

`- so1:so1`

`idx1:`

`networks:`

`splunknet:`

`aliases:`

`- idx1`

`image: ${SPLUNK_IMAGE:-splunk/splunk:latest}`

`hostname: idx1`

`container_name: idx1`

`environment:`

`- SPLUNK_START_ARGS=--accept-license`

`- SPLUNK_INDEXER_URL=idx1,idx2,idx3`

`- SPLUNK_SEARCH_HEAD_URL=sh2,sh3`

`- SPLUNK_SEARCH_HEAD_CAPTAIN_URL=sh1`

`- SPLUNK_CLUSTER_MASTER_URL=cm1`

`- SPLUNK_ROLE=splunk_indexer`

`- SPLUNK_DEPLOYER_URL=dep1`

`- SPLUNK_LICENSE_MASTER_URL=so1`

`ports:`

`-` `8000`

`-` `8089`

`volumes:`

`- ./``default``.yml:/tmp/defaults/``default``.yml`

`links:`

`- so1:so1`

`idx2:`

`networks:`

`splunknet:`

`aliases:`

`- idx2`

`image: ${SPLUNK_IMAGE:-splunk/splunk:latest}`

`hostname: idx2`

`container_name: idx2`

`environment:`

`- SPLUNK_START_ARGS=--accept-license`

`- SPLUNK_INDEXER_URL=idx1,idx2,idx3`

`- SPLUNK_SEARCH_HEAD_URL=sh2,sh3`

`- SPLUNK_SEARCH_HEAD_CAPTAIN_URL=sh1`

`- SPLUNK_CLUSTER_MASTER_URL=cm1`

`- SPLUNK_ROLE=splunk_indexer`

`- SPLUNK_DEPLOYER_URL=dep1`

`- SPLUNK_LICENSE_MASTER_URL=so1`

`ports:`

`-` `8000`

`-` `8089`

`volumes:`

`- ./``default``.yml:/tmp/defaults/``default``.yml`

`links:`

`- so1:so1`

`idx3:`

`networks:`

`splunknet:`

`aliases:`

`- idx3`

`image: ${SPLUNK_IMAGE:-splunk/splunk:latest}`

`hostname: idx3`

`container_name: idx3`

`environment:`

`- SPLUNK_START_ARGS=--accept-license`

`- SPLUNK_INDEXER_URL=idx1,idx2,idx3`

`- SPLUNK_SEARCH_HEAD_URL=sh2,sh3`

`- SPLUNK_SEARCH_HEAD_CAPTAIN_URL=sh1`

`- SPLUNK_CLUSTER_MASTER_URL=cm1`

`- SPLUNK_ROLE=splunk_indexer`

`- SPLUNK_DEPLOYER_URL=dep1`

`- SPLUNK_LICENSE_MASTER_URL=so1`

`ports:`

`-` `8000`

`-` `8089`

`volumes:`

`- ./``default``.yml:/tmp/defaults/``default``.yml`

`links:`

`- so1:so1`

`hf1:`

`networks:`

`splunknet:`

`aliases:`

`- hf1`

`image: ${SPLUNK_IMAGE:-splunk/splunk:latest}`

`hostname: hf1`

`container_name: hf1`

`environment:`

`- SPLUNK_START_ARGS=--accept-license`

`- SPLUNK_ROLE=splunk_heavy_forwarder`

`- SPLUNK_INDEXER_URL=idx1,idx2,idx3`

`- SPLUNK_ADD=tcp` `1514`

`- SPLUNK_PASSWORD`

`- SPLUNK_LICENSE_MASTER_URL=so1`

`ports:`

`-` `1514`

`-` `8000`

`links:`

`- so1:so1`

`- idx1:idx1`

`- idx2:idx2`

`- idx3:idx3`

`hf2:`

`networks:`

`splunknet:`

`aliases:`

`- hf2`

`image: ${SPLUNK_IMAGE:-splunk/splunk:latest}`

`hostname: hf2`

`container_name: hf2`

`environment:`

`- SPLUNK_START_ARGS=--accept-license`

`- SPLUNK_ROLE=splunk_heavy_forwarder`

`- SPLUNK_INDEXER_URL=idx1,idx2,idx3`

`- SPLUNK_ADD=tcp` `1514`

`- SPLUNK_PASSWORD`

`- SPLUNK_LICENSE_MASTER_URL=so1`

`ports:`

`-` `1514`

`-` `8000`

`links:`

`- so1:so1`

`- idx1:idx1`

`- idx2:idx2`

`- idx3:idx3`

`web1:`

`networks:`

`splunknet:`

`aliases:`

`- web1`

`image: nginx:latest`

`hostname: web1`

`container_name: web1`

`volumes:`

`- ./conf/web1/``default``.conf:/etc/nginx/conf.d/``default``.conf`

`- ./conf/web1/web1.log:/etc/nginx/log/`

`# - ./conf/web1/hosts:/etc/hosts`

`ports:`

`-` `9081``:``80`

`links:`

`- syslog:syslog`

`web2:`

`networks:`

`splunknet:`

`aliases:`

`- web2`

`image: nginx:latest`

`hostname: web2`

`container_name: web2`

`volumes:`

`- ./conf/web2/``default``.conf:/etc/nginx/conf.d/``default``.conf`

`- ./conf/web2/web2.log:/etc/nginx/log/`

`# - ./conf/web2/hosts:/etc/hosts`

`ports:`

`-` `9082``:``80`

`links:`

`- syslog:syslog`

`syslog:`

`networks:`

`splunknet:`

`aliases:`

`- syslog`

`image: syslog:latest`

`hostname: syslog`

`container_name: syslog`

`user: root`

`cap_add:`

`- ALL`

`- NET_ADMIN`

`- SYS_ADMIN`

- پس از ایجاد فایل مرحلی قبل دایرکتوری و فایل زیر ساخته شود:

`mkdir /opt/splunk-compose/conf`

`vim /opt/splunk-compose/conf/web1/deafult.conf`

`vim /opt/splunk-compose/conf/web2/deafult.conf`

- تنظیمات مربوط به فایل کانفیگ nginx برای دو سرور web1 و web2 در داخل فایل های ساخته شده در مرحله ی قبل قرار گیرد :

`log_format apm` `'time="$time_local" '`

`'client=$remote_addr '`

`'method=$request_method '`

`'request="$request" '`

`'request_length=$request_length '`

`'status=$status '`

`'bytes_sent=$bytes_sent '`

`'body_bytes_sent=$body_bytes_sent '`

`'referer=$http_referer '`

`'user_agent=$http_user_agent '`

`'upstream_addr=$upstream_addr '`

`'upstream_status=$upstream_status '`

`'request_time=$request_time '`

`'upstream_response_time=$upstream_response_time '`

`'http_x_forwarded_for=$http_x_forwarded_for '`

`'upstream_connect_time=$upstream_connect_time '`

`'upstream_header_time=$upstream_header_time '`

`'http_cookie=$http_cookie '``;`

`########################################################################`

`#` `'message_body="$request_body" '` `;`

`server {`

`listen` `80``;`

`listen [::]:``80``;`

`server_name localhost;`

`#charset koi8-r;`

`#access_log /var/log/nginx/host.access.log main;`

`location / {`

`root /usr/share/nginx/html;`

`index index.html index.htm;`

`access_log syslog:server=``10.10``.``15.15``:``514` `apm;`

`access_log /etc/nginx/log/access.log;`

`}`

`#error_page` `404` `/``404``.html;`

`# redirect server error pages to the` `static` `page /50x.html`

`#`

`error_page` `500` `502` `503` `504` `/50x.html;`

`location = /50x.html {`

`root /usr/share/nginx/html;`

`}`

`# proxy the PHP scripts to Apache listening on` `127.0``.``0.1``:``80`

`#`

`#location ~ \.php$ {`

`# proxy_pass http:``//127.0.0.1;`

`#}`

`# pass the PHP scripts to FastCGI server listening on` `127.0``.``0.1``:``9000`

`#`

`#location ~ \.php$ {`

`# root html;`

`# fastcgi_pass` `127.0``.``0.1``:``9000``;`

`# fastcgi_index index.php;`

`# fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name;`

`# include fastcgi_params;`

`#}`

`# deny access to .htaccess files,` `if` `Apache's document root`

`# concurs with nginx's one`

`#`

`#location ~ /\.ht {`

`# deny all;`

`#}`

`}`

- نکته در فایل بالا در قسمت access_log syslog:server=10.10.15.15:514 apm آدرس آی پی کانتینر syslog گذاشته شود.
- بالا آوردن فایل کامپوز مربوط به کلاستر:

`SPLUNK_PASSWORD=<password> docker-compose -f splunk-compose.yml up -d`

- در مرحله ی آخر وارد کانتینر syslog شده و با استفاده از دستورات زیر ترافیک دریافتی را به سمت heavy forwarder ها می فرستیم:

`docker exec -it syslog /bin/bash`

`ipvsadm -A -u` `10.10``.``15.15``:``514` `-s lc`

`ipvsadm -a -u` `10.10``.``15.15``:``514` `-r hf1:``1514` `-m`

`ipvsadm -a -u` `10.10``.``15.15``:``514` `-r hf2:``1514` `-m`

نکته : آی پی های ذکر شده را با آی پی های کانتینر خود جایگزین کنید.

در آخر برای تست می توانید از طریق لینک nginx ها و رفرش آن ها ترافیک را از طریق بالاترین لایه یعنی search head مشاهده کنید.

id: 1c88155dd4a441a9b6e36225c3341efc
parent_id: 2700abf6b5f5483881bd8b53cf358310
created_time: 2024-08-12T12:25:21.502Z
updated_time: 2024-08-12T12:27:16.861Z
is_conflict: 0
latitude: 35.68919750
longitude: 51.38897360
altitude: 0.0000
author: 
source_url: 
is_todo: 0
todo_due: 0
todo_completed: 0
source: joplin-desktop
source_application: net.cozic.joplin-desktop
application_data: 
order: 0
user_created_time: 2024-08-12T12:25:21.502Z
user_updated_time: 2024-08-12T12:27:16.861Z
encryption_cipher_text: 
encryption_applied: 0
markup_language: 1
is_shared: 0
share_id: 
conflict_original_id: 
master_key_id: 
user_data: 
deleted_time: 0
type_: 1